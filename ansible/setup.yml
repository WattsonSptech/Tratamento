- name: Install Python 3 and Java 11
  hosts: all
  become: yes
  vars:
     project_dir: /home/ubuntu/tratamento
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install Python 3
      package:
        name: python3
        state: present

    - name: Install OpenJDK Java 11 
      apt:
        name: openjdk-11-jdk
        state: present
      
    - name: Install pip
      apt:
         name: python3-pip
         state: present

    - name: Install pip
      apt:
         name: python3.12-venv
         state: present


    - name: Criar virtualenv para PySpark
      command: python3 -m venv /opt/pyspark-venv
      args:
        creates: /opt/pyspark-venv/bin/activate

    - name: Instalar PySpark dentro da virtualenv
      pip:
        name: pyspark
        virtualenv: /opt/pyspark-venv

    - name: Mostrar versão do PySpark
      command: /opt/pyspark-venv/bin/python -m pip show pyspark
      register: pyspark_info


    - name: Cria diretório do projeto na EC2
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: "0755"

    - name: Copia todo o projeto "tratamento/" para a EC2
      copy:
        src: ../tratamento/
        dest: "{{ project_dir }}/"
        mode: "0755"

    - name: Instala dependências via requirements.txt
      pip:
        requirements: "{{ project_dir }}/requirements.txt"
        executable: pip3

    - name: Executa o main.py do projeto
      command: python3 "{{ project_dir }}/Main.py"
